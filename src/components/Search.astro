---
import BuscarIcon from "./Icons/Buscar.astro";
import { db } from "../db/client";
import { users } from "../db/schema";
import { not, eq, like, or } from "drizzle-orm";

const currentUserId = Astro.cookies.get("user_id")?.number() || 0;

// Get all users except current user for search
const allUsers = await db
    .select({
        id: users.id,
        name: users.name,
        email: users.email,
        photo: users.photo,
    })
    .from(users)
    .where(not(eq(users.id, currentUserId)));
---

<div
    id="barra-busqueda-contenedor"
    class="hidden sm:ml-65 bg-neutral-950 bg-[radial-gradient(ellipse_80%_80%,rgba(120,119,198,0.3),rgba(255,255,255,0))] bg-opacity-70 shadow-sm shadow-black/5"
>
    <div class="max-w-xl mx-auto">
        <div class="relative">
            <div
                class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none z-10"
            >
                <BuscarIcon class="size-5" />
            </div>
            <input
                type="search"
                id="search-input-field"
                class="block w-full p-3 ps-9 bg-white border border-gray-300 text-black text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm placeholder:text-gray-400"
                placeholder="Buscar usuarios..."
                autocomplete="off"
            />
        </div>
        <div id="search-results" class="mt-4 hidden">
            <div class="bg-black rounded-lg shadow-md max-h-96 overflow-y-auto">
                <div id="results-container" class="divide-y divide-gray-200">
                </div>
                <div id="no-results" class="hidden p-4 text-center text-white">
                    No se encontraron usuarios
                </div>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ allUsers }}>
    const botonBuscar = document.getElementById("boton-activar-busqueda");
    const contenedorBusqueda = document.getElementById(
        "barra-busqueda-contenedor",
    );
    const campoBusqueda = document.getElementById("search-input-field");
    const searchResults = document.getElementById("search-results");
    const resultsContainer = document.getElementById("results-container");
    const noResults = document.getElementById("no-results");

    if (botonBuscar && contenedorBusqueda && campoBusqueda) {
        botonBuscar.addEventListener("click", () => {
            contenedorBusqueda.classList.toggle("hidden");

            if (!contenedorBusqueda.classList.contains("hidden")) {
                campoBusqueda.focus();
            } else {
                campoBusqueda.value = "";
                searchResults.classList.add("hidden");
            }
        });
        campoBusqueda.addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();

            if (searchTerm === "") {
                searchResults.classList.add("hidden");
                return;
            }
            const filteredUsers = allUsers.filter(
                (user) =>
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm),
            );
            if (filteredUsers.length > 0) {
                resultsContainer.innerHTML = filteredUsers
                    .map(
                        (user) => `
                    <a href="/chat/${user.id}" class="text-white flex items-center space-x-3 p-4 hover:bg-gray-800 hover:text-black transition">
                        <img
                            src="${user.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=48`}"
                            alt="${user.name}"
                            class="w-12 h-12 rounded-full object-cover"
                        />
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white truncate">${user.name}</p>
                            <p class="text-sm text-white truncate">${user.email}</p>
                        </div>
                    </a>
                `,
                    )
                    .join("");
                noResults.classList.add("hidden");
            } else {
                resultsContainer.innerHTML = "";
                noResults.classList.remove("hidden");
            }

            searchResults.classList.remove("hidden");
        });
        document.addEventListener("click", (e) => {
            if (
                !contenedorBusqueda.contains(e.target) &&
                !botonBuscar.contains(e.target)
            ) {
                contenedorBusqueda.classList.add("hidden");
                campoBusqueda.value = "";
                searchResults.classList.add("hidden");
            }
        });
    }
</script>
