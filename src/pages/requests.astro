---
import Layout from "../layouts/Layout.astro";
import { db } from "../db/client";
import { friendships, users } from "../db/schema";
import { eq, and } from "drizzle-orm";

const currentUserId = Astro.cookies.get("user_id")?.number();

if (!currentUserId) {
    return Astro.redirect("/login");
}

// Get pending friend requests where current user is the receiver
const pendingRequests = await db
    .select({
        id: friendships.id,
        senderId: friendships.userId1,
        senderName: users.name,
        senderPhoto: users.photo,
        createdAt: friendships.createdAt,
    })
    .from(friendships)
    .leftJoin(users, eq(friendships.userId1, users.id))
    .where(
        and(
            eq(friendships.userId2, currentUserId),
            eq(friendships.status, "pending"),
        ),
    );
---

<Layout>
    <div
        class="ml-[260px] px-8 py-10 bg-neutral-950 bg-[radial-gradient(ellipse_80%_80%_at_50%_-20%,rgba(120,119,198,0.3),rgba(255,255,255,0))] min-h-screen"
    >
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-semibold mb-6 text-purple-500">
                Solicitudes de Amistad
            </h1>

            {
                pendingRequests.length === 0 ? (
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <p class="text-gray-500">
                            No tienes solicitudes pendientes
                        </p>
                    </div>
                ) : (
                    <div class="space-y-4">
                        {pendingRequests.map((request) => (
                            <div class="bg-white rounded-lg shadow-md p-6 flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <img
                                        src={
                                            request.senderPhoto ||
                                            `https://ui-avatars.com/api/?name=${encodeURIComponent(request.senderName!)}`
                                        }
                                        alt={request.senderName}
                                        class="w-16 h-16 rounded-full object-cover"
                                    />
                                    <div>
                                        <h3 class="font-semibold text-lg">
                                            {request.senderName}
                                        </h3>
                                        <p class="text-sm text-gray-500">
                                            {new Date(
                                                request.createdAt!,
                                            ).toLocaleDateString("es-ES", {
                                                day: "numeric",
                                                month: "long",
                                                year: "numeric",
                                            })}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex space-x-3">
                                    <form
                                        action="/api/friends/accept"
                                        method="POST"
                                        class="inline"
                                    >
                                        <input
                                            type="hidden"
                                            name="friendshipId"
                                            value={request.id}
                                        />
                                        <button
                                            type="submit"
                                            class="bg-lime-300 text-black px-4 py-2 rounded-lg hover:bg-lime-500 transition font-medium"
                                        >
                                            Aceptar
                                        </button>
                                    </form>
                                    <form
                                        action="/api/friends/reject"
                                        method="POST"
                                        class="inline"
                                    >
                                        <input
                                            type="hidden"
                                            name="friendshipId"
                                            value={request.id}
                                        />
                                        <button
                                            type="submit"
                                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition font-medium"
                                        >
                                            Rechazar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        ))}
                    </div>
                )
            }
        </div>
    </div>
</Layout>
