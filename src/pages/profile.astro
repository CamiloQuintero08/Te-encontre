---
import Layout from "../layouts/Layout.astro";
import { db } from "../db/client";
import { users } from "../db/schema";
import { eq } from "drizzle-orm";

const currentUserId = Astro.cookies.get("user_id")?.number();

if (!currentUserId) {
    return Astro.redirect("/login");
}

// Get current user info
const currentUser = await db
    .select()
    .from(users)
    .where(eq(users.id, currentUserId));

if (currentUser.length === 0) {
    return Astro.redirect("/login");
}

const user = currentUser[0];
---

<Layout>
    <div class="ml-[260px] px-8 py-10">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl font-semibold mb-6">Mi Perfil</h1>

            <div class="bg-white rounded-lg shadow-md p-6">
                <!-- Current Profile Photo -->
                <div class="flex items-center space-x-6 mb-6">
                    <img
                        src={user.photo ||
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=128`}
                        alt={user.name}
                        class="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                    />
                    <div>
                        <h2 class="text-2xl font-semibold">{user.name}</h2>
                        <p class="text-gray-500">{user.email}</p>
                        <p class="text-sm text-gray-400 mt-1">
                            Miembro desde {
                                new Date(user.createdAt!).toLocaleDateString(
                                    "es-ES",
                                    {
                                        day: "numeric",
                                        month: "long",
                                        year: "numeric",
                                    },
                                )
                            }
                        </p>
                    </div>
                </div>

                <!-- Update Photo Form -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold mb-4">
                        Actualizar Foto de Perfil
                    </h3>
                    <form
                        action="/api/profile/update-photo"
                        method="POST"
                        enctype="multipart/form-data"
                        class="space-y-4"
                    >
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                            >
                                Nueva foto de perfil
                            </label>
                            <input
                                type="file"
                                name="photo"
                                accept="image/jpeg,image/png,image/gif,image/webp"
                                required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                MÃ¡ximo 5MB. Formatos: JPG, PNG, GIF, WEBP
                            </p>
                        </div>
                        <div class="flex justify-end">
                            <button
                                type="submit"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium"
                            >
                                Actualizar Foto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</Layout>
