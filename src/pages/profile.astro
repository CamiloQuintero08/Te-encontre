---
import Layout from "../layouts/Layout.astro";
import PostCard from "../components/PostCard.astro";
import { db } from "../db/client";
import { users } from "../db/schema";
import { eq, sql } from "drizzle-orm";

const currentUserId = Astro.cookies.get("user_id")?.number();

if (!currentUserId) {
    return Astro.redirect("/login");
}

// Get current user info from VIEW
const currentUser = await db.execute(
    sql`SELECT * FROM user_profile_summary WHERE id = ${currentUserId}`,
);

if ((currentUser[0] as any).length === 0) {
    return Astro.redirect("/login");
}

// @ts-ignore
const user = currentUser[0][0];

// Get user's posts
const userPosts = await db.execute(
    sql`SELECT * FROM post_details_view WHERE author_id = ${currentUserId} ORDER BY created_at DESC`,
);
const posts = userPosts[0] as unknown as any[];
---

<Layout>
    <div class="ml-[260px] px-8 py-10 bg-linear-to-b from-blue-200 to-white min-h-screen">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-orange-500">Mi Perfil</h1>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center space-x-6 mb-6">
                    <img
                        src={user.photo ||
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&size=128`}
                        alt={user.name}
                        class="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                    />
                    <div>
                        <h2 class="text-2xl font-semibold">{user.name}</h2>
                        <p class="text-gray-500">{user.email}</p>
                        <p class="text-sm text-gray-400 mt-1">
                            Miembro desde {
                                new Date(user.created_at!).toLocaleDateString(
                                    "es-ES",
                                    {
                                        day: "numeric",
                                        month: "long",
                                        year: "numeric",
                                    },
                                )
                            }
                        </p>
                    </div>
                </div>
                <div class="flex space-x-8 ml-auto">
                    <div class="text-center">
                        <span class="block text-xl font-bold text-gray-900"
                            >{user.post_count}</span
                        >
                        <span class="text-sm text-gray-500">Posts</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-gray-900"
                            >{user.friend_count}</span
                        >
                        <span class="text-sm text-gray-500">Amigos</span>
                    </div>
                </div>
            </div>

            <!-- Update Photo Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                <h3 class="text-lg font-semibold mb-4">
                    Actualizar Foto de Perfil
                </h3>
                <form
                    action="/api/profile/update-photo"
                    method="POST"
                    enctype="multipart/form-data"
                    class="space-y-4"
                >
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Nueva foto de perfil
                        </label>
                        <input
                            type="file"
                            name="photo"
                            accept="image/jpeg,image/png,image/gif,image/webp"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                        <p class="text-xs text-gray-500 mt-1">
                            Máximo 5MB. Formatos: JPG, PNG, GIF, WEBP
                        </p>
                    </div>
                    <div class="flex justify-end">
                        <button
                            type="submit"
                            class="bg-yellow-500 text-black px-6 py-2 rounded-lg hover:bg-orange-500 transition font-medium"
                        >
                            Actualizar Foto
                        </button>
                    </div>
                </form>
            </div>

            <div class="mt-10">
                <h2 class="text-2xl font-semibold mb-6">Mis Publicaciones</h2>
                <div class="space-y-6">
                    {
                        posts.map((post) => (
                            <PostCard
                                post={{
                                    id: post.post_id,
                                    content: post.content,
                                    imageUrl: post.image_url,
                                    createdAt: new Date(post.created_at),
                                    author: {
                                        id: post.author_id,
                                        name: post.author_name,
                                        photo: post.author_photo,
                                    },
                                    likesCount: post.like_count,
                                    isLikedByUser: false,
                                    commentsCount: post.comment_count,
                                    comments: [],
                                }}
                            />
                        ))
                    }
                    {
                        posts.length === 0 && (
                            <p class="text-gray-500 text-center py-10">
                                No has publicado nada aún.
                            </p>
                        )
                    }
                </div>
            </div>
        </div>
    </div>
</Layout>
